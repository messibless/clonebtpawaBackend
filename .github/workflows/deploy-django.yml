name: Deploy Django Backend to Server

on:
  push:
    branches: [ main, master ]  # Trigger on push to main/master
  pull_request:
    branches: [ main, master ]  # Optional: trigger on PR

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'  # Tumia version yako ya Python
          cache: 'pip'  # Cache pip dependencies

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          # Check if requirements.txt exists
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "âš ï¸ requirements.txt not found!"
            exit 1
          fi

      - name: Run Tests (Optional)
        run: |
          python manage.py test  # Run Django tests
        continue-on-error: true  # Continue even if tests fail

      - name: Collect Static Files
        run: |
          python manage.py collectstatic --noinput  # Collect static files

      - name: Deploy to Server via Rsync
        uses: burnett01/rsync-deployments@7.0
        with:
          switches: -avzr --delete --exclude='.env' --exclude='*.pyc' --exclude='__pycache__' --exclude='db.sqlite3' --exclude='.git' --exclude='.github'
          path: ./  
          remote_path: /var/www/betpawa-backend/  # Path kwenye server
          remote_host: ${{ secrets.SERVER_HOST }}
          remote_user: ${{ secrets.SERVER_USER }}
          remote_key: ${{ secrets.SERVER_SSH_KEY }}

      - name: Execute Remote Commands
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            echo "ğŸš€ Starting deployment on server..."
            
            # Navigate to project directory
            cd /var/www/betpawa-backend
            
            # Show current directory and files
            echo "ğŸ“‚ Current directory: $(pwd)"
            ls -la
            
            # Activate virtual environment (create if doesn't exist)
            if [ ! -d "venv" ]; then
              echo "ğŸ”§ Creating virtual environment..."
              python3 -m venv venv
            fi
            
            # Activate virtual environment
            echo "ğŸ”Œ Activating virtual environment..."
            source venv/bin/activate
            
            # Show Python and pip versions
            echo "ğŸ Python version: $(python --version)"
            echo "ğŸ“¦ Pip version: $(pip --version)"
            
            # Check if requirements.txt exists
            if [ -f requirements.txt ]; then
              echo "ğŸ“¦ Installing dependencies from requirements.txt..."
              pip install -r requirements.txt
            else
              echo "âš ï¸ requirements.txt not found on server!"
              exit 1
            fi
            
            # Run database migrations
            echo "ğŸ”„ Running database migrations..."
            python manage.py migrate --noinput
            
            # Collect static files
            echo "ğŸ¨ Collecting static files..."
            python manage.py collectstatic --noinput
            
            # Restart Gunicorn service
            echo "ğŸ”„ Restarting Gunicorn..."
            sudo systemctl restart gunicorn || {
              echo "âš ï¸ Gunicorn restart failed, trying alternative..."
              pkill -f gunicorn || true
              nohup gunicorn --bind 0.0.0.0:8000 vbclone_backend.wsgi:application > gunicorn.log 2>&1 &
            }
            
            # Restart Nginx
            echo "ğŸ”„ Reloading Nginx..."
            sudo systemctl reload nginx || sudo systemctl restart nginx
            
            # Check service status
            echo "ğŸ“Š Service status:"
            sudo systemctl status gunicorn --no-pager || echo "âš ï¸ Gunicorn status check failed"
            sudo systemctl status nginx --no-pager | grep "Active:"
            
            echo "âœ… Deployment completed successfully!"
            
            # Show last few lines of gunicorn log
            if [ -f gunicorn.log ]; then
              echo "ğŸ“‹ Last 5 lines of gunicorn log:"
              tail -5 gunicorn.log
            fi

      - name: Health Check
        if: success()
        run: |
          echo "ğŸ” Running health check..."
          sleep 10  # Wait for services to start
          curl -f http://${{ secrets.SERVER_HOST }}/health/ || echo "âš ï¸ Health check failed, but deployment may still be successful"